name: Create feedstocks

on:
  push:
    branches:
      - master
  schedule:
    - cron:  '*/5 * * * *'

jobs:
  create-feedstocks:
    name: Create feedstocks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Prevent multiple jobs running in parallel
        uses: softprops/turnstyle@v1
        with:
          abort-after-seconds: 3
          poll-interval-seconds: 2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run feedstock creation
        run: |
            # Avoid wasting CI time if there are no recipes ready for conversion
            if [ "$(ls recipes/*/meta.yaml | grep -v recipes/example/meta.yaml --count)" -eq 0 ]; then
              echo "No new recipes found, exiting..."
              exit 0
            fi

            echo "Creating feedstocks from the recipe(s)."

            git config --global user.name "GitHub Actions on github.com/conda-forge/staged-recipes"
            git config --global user.email "conda-forge@googlegroups.com"

            # chrisburr: disable feedstock creation while testing overlaps
            # sleep for 15 minutes for now
            sleep 900
            # source ./.travis_scripts/create_feedstocks
