{% set version = "1.5.3" %}
{% set number = 0 %}

{% if cuda_compiler_version != "None" %}
{% set number = number + 200 %}
{% endif %}

package:
  name: mmcv-recipe
  version: {{ version }}

source:
  url: https://github.com/open-mmlab/mmcv/archive/refs/tags/v{{ version }}.tar.gz
build:
  number: {{ number }}
  skip: true  # [win]

outputs:
  - name: mmcv-full
    build:
      string: cuda{{ cuda_compiler_version | replace('.', '') }}py{{ CONDA_PY }}h{{ PKG_HASH }}_{{ PKG_BUILDNUM }}  # [cuda_compiler_version != "None"]
      string: cpu_py{{ CONDA_PY }}h{{ PKG_HASH }}_{{ PKG_BUILDNUM }}                                      # [cuda_compiler_version == "None"]
      detect_binary_files_with_prefix: false
      run_exports:
        - {{ pin_subpackage('mmcv-full', max_pin='x.x') }}
    script: build_mmcv.sh  # [not win]
    requirements:
      build:
        - python                                 # [build_platform != target_platform]
        - cross-python_{{ target_platform }}     # [build_platform != target_platform]
        - numpy                                  # [build_platform != target_platform]
        - sysroot_linux-64  2.17  # [linux64]
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
        - {{ compiler('cuda') }}    # [cuda_compiler_version != "None"]
        # Should be fixed in other versions
        # https://gitlab.kitware.com/cmake/cmake/-/issues/23368
        - cmake  !=3.23.0
        - ninja
        - make      # [linux]
      host:
        # GPU requirements
        - cudnn                           # [cuda_compiler_version != "None"]
        # other requirements
        - python
        - numpy
        # dataclasses is a backport of python 3.7 module
        - dataclasses   # [py==36]
        - pip
        - pyyaml
        - requests
        - future
        - six
        - typing
        - pkg-config  # [unix]
        - typing_extensions
        #- pytorch
      run:
        # GPU requirements without run_exports
        - {{ pin_compatible('cudnn') }}                       # [cuda_compiler_version != "None"]
        # other requirements
        - python
        - {{ pin_compatible('numpy') }}
        - Pillow
        - pyyaml
        - yapf
        - setuptools
        - typing_extensions
        # Need ninja to load C++ extensions (?)
        - ninja
        - pytorch
        # Conda exposes the maximum CUDA version supported by the installed Nvidia drivers through a virtual pockage
        - __cuda  # [cuda_compiler_version != "None"]
about:
  home: https://github.com/open-mmlab/mmcv
  summary: 'Foundational library for computer vision research'
  description: |
    MMCV is a foundational library for computer vision research and supports many research projects.
  license: MIT
  license_family: MIT
  license_file: LICENSE.txt
  dev_url: https://github.com/open-mmlab/mmcv

extra:
  recipe-maintainers:
    - apatsekin
