Conditionally include err.h on platforms that have it.  compat.c
provides fallback implementations for the necessary functions.
--- tvips/CMakeLists.txt.orig
+++ tvips/CMakeLists.txt
@@ -94,6 +94,10 @@ CHECK_C_SOURCE_COMPILES("
   BSWAP_STDLIB_H)
 
 
+# Check if <err.h> can be included.
+check_include_file(err.h HAVE_ERR_H)
+
+
 # Check whether certain error numbers are defined by <errno.h>.
 CHECK_SYMBOL_EXISTS(EMSGSIZE errno.h HAVE_EMSGSIZE)
 CHECK_SYMBOL_EXISTS(ENOMSG errno.h HAVE_ENOMSG)
@@ -261,6 +265,7 @@ target_link_libraries(dumpframe Iconv::Iconv ${TIFF_LIBRARIES})
 
 if(BUILD_JIFFIES)
 add_executable(fixpoint
+  "compat.c"
   "delta_t.cpp"
   "fixpoint.c")
 add_dependencies(fixpoint _update_version_h)
@@ -371,6 +376,7 @@ target_link_libraries(mrc2smv
 
 if(BUILD_JIFFIES)
 add_executable(rawdump
+  "compat.c"
   "rawdump.c")
 target_link_libraries(rawdump m)
 endif()
--- tvips/config.h.in.orig
+++ tvips/config.h.in
@@ -72,9 +72,6 @@
  * of the non-standard err(3) and warnx(3) functions.
  */
 #cmakedefine HAVE_ERR_H
-#if defined(HAVE_ERR_H)
-#    include <err.h>
-#endif
 
 #cmakedefine HAVE_ERR
 #if !defined(HAVE_ERR)
--- tvips/cphdr.c.orig
+++ tvips/cphdr.c
@@ -24,7 +24,9 @@
 
 #include <stdlib.h>
 
-#include <err.h>
+#ifdef HAVE_ERR_H
+#    include <err.h>
+#endif
 
 #include "frame.h"
 
--- tvips/dan_test.c.orig
+++ tvips/dan_test.c
@@ -24,7 +24,9 @@
 
 #include <stdlib.h>
 
-#include <err.h>
+#ifdef HAVE_ERR_H
+#    include <err.h>
+#endif
 #include <math.h>
 #include <string.h>
 
--- tvips/dumpframe.c.orig
+++ tvips/dumpframe.c
@@ -53,7 +53,9 @@ TemData structure via old tag
 
 #include <stdlib.h>
 
-#include <err.h>
+#ifdef HAVE_ERR_H
+#    include <err.h>
+#endif
 #include <errno.h> // XXX Late addition
 #include <float.h> // XXX Late addition
 #include <limits.h> // XXX Late addition
--- tvips/fixpoint.c.orig
+++ tvips/fixpoint.c
@@ -25,7 +25,9 @@
 #include <stdio.h>
 #include <stdlib.h>
 
-#include <err.h>
+#ifdef HAVE_ERR_H
+#    include <err.h>
+#endif
 #include <math.h>
 #include <unistd.h>
 
--- tvips/img2img.c.orig
+++ tvips/img2img.c
@@ -24,7 +24,9 @@
 
 #include <stdlib.h>
 
-#include <err.h>
+#ifdef HAVE_ERR_H
+#    include <err.h>
+#endif
 
 #include "frame.h"
 
--- tvips/img2px.c.orig
+++ tvips/img2px.c
@@ -27,7 +27,9 @@
 #include <stdbool.h>
 #include <stdlib.h>
 
-#include <err.h>
+#ifdef HAVE_ERR_H
+#    include <err.h>
+#endif
 #include <errno.h>
 #include <getopt.h>
 #include <math.h>
--- tvips/img2splot.c.orig
+++ tvips/img2splot.c
@@ -24,7 +24,9 @@
 
 #include <stdlib.h>
 
-#include <err.h>
+#ifdef HAVE_ERR_H
+#    include <err.h>
+#endif
 #include <errno.h>
 #include <getopt.h>
 #include <string.h>
--- tvips/imgcorr.c.orig
+++ tvips/imgcorr.c
@@ -24,7 +24,9 @@
 
 #include <stdlib.h>
 
-#include <err.h>
+#ifdef HAVE_ERR_H
+#    include <err.h>
+#endif
 #include <math.h>
 #include <string.h>
 
--- tvips/imgrevert.c.orig
+++ tvips/imgrevert.c
@@ -24,7 +24,9 @@
 
 #include <stdlib.h>
 
-#include <err.h>
+#ifdef HAVE_ERR_H
+#    include <err.h>
+#endif
 #include <errno.h>
 #include <string.h>
 #include <unistd.h>
--- tvips/mike_test.c.orig
+++ tvips/mike_test.c
@@ -24,7 +24,9 @@
 
 #include <stdlib.h>
 
-#include <err.h>
+#ifdef HAVE_ERR_H
+#    include <err.h>
+#endif
 #include <libgen.h>
 #include <string.h>
 #include <unistd.h>
--- tvips/mrc2smv.c.orig
+++ tvips/mrc2smv.c
@@ -33,7 +33,9 @@
 #include <stdio.h>
 #include <stdlib.h>
 
-#include <err.h>
+#ifdef HAVE_ERR_H
+#    include <err.h>
+#endif
 #include <errno.h>
 #include <getopt.h>
 #include <libgen.h>
--- tvips/rawdump.c.orig
+++ tvips/rawdump.c
@@ -18,11 +18,17 @@
  * CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
  */
 
+#ifdef HAVE_CONFIG_H
+#    include "config.h"
+#endif
+
 #include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 
-#include <err.h>
+#ifdef HAVE_ERR_H
+#    include <err.h>
+#endif
 #include <math.h>
 
 
--- tvips/smv2pgm.c.orig
+++ tvips/smv2pgm.c
@@ -24,7 +24,9 @@
 
 #include <stdlib.h>
 
-#include <err.h>
+#ifdef HAVE_ERR_H
+#    include <err.h>
+#endif
 
 #include "frame.h"
 
--- tvips/tiff2raw.c.orig
+++ tvips/tiff2raw.c
@@ -24,7 +24,9 @@
 
 #include <stdlib.h>
 
-#include <err.h>
+#ifdef HAVE_ERR_H
+#    include <err.h>
+#endif
 
 #include "frame.h"
 #include "tvips.h"
