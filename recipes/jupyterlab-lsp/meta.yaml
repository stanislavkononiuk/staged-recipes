{% set name = "jupyter-lsp" %}
{% set version = "0.8.0" %}
{% set jupyterlab_version = ">=2,<3.0.0a0" %}
{% set server_tests = ["start_known", "listener"] %}  # List of jupyter_lsp py.tests ran for each known servers

package:
  name: {{ name }}-suite  # To avoid issue https://github.com/conda/conda-build/issues/3933
  version: {{ version }}

source:
  url: https://pypi.io/packages/source/{{ name[0] }}/{{ name }}/{{ name }}-{{ version }}.tar.gz
  sha256: 3abe20ec48a3f6b132653abe597af2b6cd0005539ab0d74e0ba203927124d333

build:
  noarch: python
  number: 0

outputs:
  - name: {{ name }}
    script: build_base.bat  # [win]
    script: build_base.sh  # [not win]
    requirements:
      host:
        - python
        - pip
      run:
        - notebook >=4.3.1
        - python
        - setuptools
    test:
      requires:
        - jupyterlab {{ jupyterlab_version }}
        - nodejs >=10
      commands:
        - jupyter labextension install @krassowski/jupyterlab-lsp@^1.0.0
        - python -m jupyterlab.browser_check
  - name: {{ name }}-python
    build:
    requirements:
      run:
        - {{ pin_subpackage(name, exact=True) }}
        - python-language-server
    test:
      requires:
        - jupyterlab {{ jupyterlab_version }}
        - pytest-asyncio
        - pytest-runner
      commands:
        - pytest -vv -p no:warnings --pyargs jupyter_lsp -k "not ({{ server_tests|join(' or ') }}) or pyls"
  - name: {{ name }}-r
    build:
    requirements:
      run:
        - {{ pin_subpackage(name, exact=True) }}
        - r-languageserver >=0.3.5  # Snippets support https://github.com/krassowski/jupyterlab-lsp/issues/208
    test:
      requires:
        - jupyterlab {{ jupyterlab_version }}
        - pytest-asyncio
        - pytest-runner
      commands:
        - pytest -vv -p no:warnings --pyargs jupyter_lsp -k "not ({{ server_tests|join(' or ') }}) or r-languageserver"

about:
  home: https://github.com/krassowski/jupyterlab-lsp
  license: BSD-3-Clause
  license_family: BSD
  license_file: LICENSE
  summary: Multi-Language Server WebSocket proxy for Jupyter notebook or lab server for Python 3.5+.
  doc_url: https://jupyterlab-lsp.readthedocs.io

extra:
  recipe-maintainers:
    - bollwyvl
    - fcollonval
    - krassowski
