{% set version = "0.8.0" %}

package:
  name: ray
  version: {{ version }}

source:
  url: https://github.com/ray-project/ray/archive/ray-{{ version }}.tar.gz
  sha256: 2da0a27e00febd16e9421261a3b3ef5352bf37378e28d1adabbf73879f910748
  patches:
    - patches/0001-remove-requires-from-setup.py.patch
    - patches/0002-do-not-vendor-pyarrow-pickle5.patch
    - patches/0003-remove-checks-for-vendored-pyarrow-pickle5.patch
    - patches/0004-no-need-to-check-import-errors-when-using-conda.patch
    - patches/0005-remove-deprecated-bazel-option.patch

build:
  number: 0
  skip: True  # [py<36]
  # wait (at least) for bazel on windows; conda-forge/bazel-feedstock/issues/36
  skip: True  # [win]

# Need these up here for conda-smithy to handle them properly.
requirements:
  build:
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
  host:
    - python
  run:
    - python

outputs:
  - name: ray-base
    build:
      # use build-script that comes with ray
      script: ./build.sh
    requirements:
      build:
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
        - cython >=0.29
        - bazel
      host:
        # TODO: check which of these can move to run-reqs
        - abseil-cpp
        - boost ==1.68.0
        - click
        - cloudpickle
        - colorama
        - filelock
        - funcsigs
        - grpc-cpp
        - jsonschema
        - numpy >=1.16
        - pickle5 ==0.0.9    # [py<38]
        - packaging
        - protobuf >=3.8.0
        - pyarrow ==0.14
        - pytest
        - pyyaml
        - redis-py >=3.3.2
        - six
        - python
        - pip
      run:
        - python
        - numpy >=1.16
        - filelock
        - funcsigs
        - click
        - colorama
        - pytest
        - pyyaml
        - redis-py >=3.3.2
        - six
        - flatbuffers
      test:
        imports:
          - ray
          - ray._raylet
          - ray.actor
          - ray.profiling
          - ray.projects
          - ray.runtime_context
          - ray.state
          - ray.tests
          - ray.worker

  - name: ray-debug
    requirements:
      host:
        - python
      run:
        - python
        - {{ pin_subpackage('ray-base', exact=True) }}
        - psutil
        - py-spy >=0.2.0
        - setproctitle

  - name: ray-dashboard
    requirements:
      host:
        - python
      run:
        - python
        - {{ pin_subpackage('ray-base', exact=True) }}
        - aiohttp
        - googlesearch
        - grpcio
        - psutil
        - setproctitle
    test:
      imports:
        - ray.dashboard

  - name: ray-serve
    build:
      # until dependencies are built
      skip: True
    requirements:
      host:
        - python
      run:
        - python
        - {{ pin_subpackage('ray-base', exact=True) }}
        # needs to be packaged:
        # - blist
        - flask
        - pandas
        - pygments
        - uvicorn
        - werkzeug
    test:
      imports:
        - ray.serve

  - name: ray-rllib
    build:
      # until dependencies are built
      skip: True
    requirements:
      host:
        - python
      run:
        - python
        - {{ pin_subpackage('ray-base', exact=True) }}
        # needs to be packaged:
        # - gym-atari
        - lz4
        - opencv
        - pyyaml
        - scipy
        - tabulate
    test:
      imports:
        - ray.rrlib

  - name: ray-tune
    requirements:
      host:
        - python
      run:
        - python
        - {{ pin_subpackage('ray-base', exact=True) }}
        - tabulate
    test:
      imports:
        - ray.tune


about:
  home: https://github.com/ray-project/ray
  license: Apache-2.0
  license_family: Apache
  license_file: LICENSE
  summary: 'Ray is a fast and simple framework for building and running distributed applications.'
  description: |
    Ray is a fast and simple framework for building and running
    distributed applications.
  doc_url: https://ray.readthedocs.io/
  dev_url: https://github.com/ray-project/ray

extra:
  recipe-maintainers:
    - dHannasch
    - h-vetinari
