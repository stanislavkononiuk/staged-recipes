{% set name = "uutils" %}
{% set version = "0.0.16" %}

{% set feature_set = "macos" %}  # [osx]
{% set feature_set = "unix" %}  # [unix and not osx]
{% set feature_set = "windows" %}  # [win]

package:
  name: {{ name|lower }}
  version: {{ version }}

source:
  url: https://github.com/uutils/coreutils/archive/{{ version }}.tar.gz
  sha256: 1bdc2838e34b6ca8275cb8e3bac5074ca59158ea077e3195fb91ec0cc6b594f6
  patches:
    - 0001-FIX_BUILDDIR_IN_MAKE.patch  # [not win]
    - 0002-SHORTEN_SH_COMMANDS.patch

build:
  script:
    - cargo build --release --features {{ feature_set }}
    - cargo install --path . --root "${PREFIX}" --features {{ feature_set }}  # [not win]
    - cargo install --path . --root "%LIBRARY_PREFIX%" --features {{ feature_set }}  # [win]
    - make PROFILE=Release PREFIX="${PREFIX}" MULTICALL=y install  # [not win]
    - for /f "usebackq tokens=*" %%i in (`cygpath %LIBRARY_PREFIX%`) do set CONVERTED_PREFIX=%%i  # [win]
    - make PROFILE=Release PREFIX="%CONVERTED_PREFIX%" MULTICALL=y install  # [win]
    - cargo-bundle-licenses --format yaml --output THIRDPARTY.yml
  number: 0
  ignore_run_exports:
    - libcxx

requirements:
  build:
    - {{ compiler('cxx') }}
    - {{ compiler('rust') }}
    - make
    - cargo-bundle-licenses

test:
  commands:
    - coreutils --help
    - test -f "${PREFIX}"/bin/coreutils  # [not win]
    - test -f "${PREFIX}"/bin/cat  # [not win]
    - if not exist %PREFIX%\bin\coreutils.exe exit 1  # [win]
    - if not exist %PREFIX%\bin\cat.exe exit 1  # [win]

about:
  home: https://github.com/uutils/coreutils
  summary: 'Cross-platform Rust rewrite of the GNU coreutils'
  description: |
    uutils is an attempt at writing universal (as in cross-platform) CLI utilities in Rust.
    uutils aims to work on as many platforms as possible,
    to be able to use the same utils on Linux, Mac, Windows and other platforms.
    This ensures, for example, that scripts can be easily transferred between platforms.
    Rust was chosen not only because it is fast and safe,
    but is also excellent for writing cross-platform code.
  license: MIT
  license_family: MIT
  license_file:
    - LICENSE
    - THIRDPARTY.yml
  doc_url: https://uutils.github.io/user/
  dev_url: https://github.com/uutils/coreutils

extra:
  recipe-maintainers:
    - sshockwave
