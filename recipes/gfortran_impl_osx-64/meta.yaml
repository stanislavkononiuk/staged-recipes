{% set gfortran_version = [7, 3, 0] %}
{% set libgfortran_version = [4, 0, 0] %}
{% set max_libgfortran_version = "5.0.0.a0" %}
{% set libquadmath_version = [0, 0, 0] %}
{% set libgcc_s_version = [1, 0, 0] %}

package:
  name: gfortran_impl_osx-64
  version: {{ gfortran_version|join('.') }}

source:
  url: https://ftp.gnu.org/gnu/gcc/gcc-{{ gfortran_version|join('.') }}/gcc-{{ gfortran_version|join('.') }}.tar.gz
  sha256: fa06e455ca198ddc11ea4ddf2a394cf7cfb66aa7e0ab98cc1184189f1d405870
  patches:
    - libgcc_macosx_min_version.patch

build:
  number: 0
  skip: True  # [not osx]

requirements:
  build:
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    - make
  host:
    - libiconv {{ libiconv }}
    - zlib {{ zlib }}
    - gmp {{ gmp }}
    - mpfr {{ mpfr }}
    - isl {{ isl }}
    - mpc ==1.1.0

outputs:
  - name: gfortran_impl_osx-64
    version: {{ gfortran_version|join('.') }}
    requirements:
      build:
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
        - make
      host:
        - libiconv {{ libiconv }}
        - zlib {{ zlib }}
        - gmp {{ gmp }}
        - mpfr {{ mpfr }}
        - isl {{ isl }}
        - mpc ==1.1.0
      run:
        - {{ pin_compatible('isl', max_pin='x.x') }}
        - {{ pin_compatible('mpfr', max_pin='x.x') }}
        - {{ pin_compatible('mpc', max_pin='x.x') }}
        - {{ pin_compatible('gmp', max_pin='x.x') }}
        - {{ pin_compatible('zlib', max_pin='x.x') }}
        - {{ pin_compatible('libiconv', max_pin='x.x') }}
    script: install-gfortran_impl_osx-64.sh
    test:
      script: run_test.sh

  - name: libgfortran
    version: {{ libgfortran_version|join('.') }}
    requirements:
      build:
        - {{ pin_subpackage('gfortran_impl_osx-64', exact=True) }}
      host:
        # we seem to need a dummy package here to make sure the host env
        # and build envs are created properly - I'm using make 'cause shrug
        - make
    script: install-libgfortran.sh
    run_exports:
      - libgfortran >={{ libgfortran_version|join('.') }},<{{ max_libgfortran_version }}
    test:
      commands:
        - test -f "${PREFIX}/lib/libgfortran.dylib"
        - test -f "${PREFIX}/lib/libgfortran.{{ libgfortran_version[0] }}.dylib"

        - test -f "${PREFIX}/lib/libgomp.dylib"
        - test -f "${PREFIX}/lib/libgomp.{{ libgcc_s_version[0] }}.dylib"

        # Including libquadmath for the time
        # being. This will need to be broken
        # out in the long term.
        - test -f "${PREFIX}/lib/libquadmath.dylib"
        - test -f "${PREFIX}/lib/libquadmath.{{ libquadmath_version[0] }}.dylib"

        # Including libgcc_s for the time
        # being. This will need to be broken
        # out in the long term.
        - test -f "${PREFIX}/lib/libgcc_s.{{ libgcc_s_version[0] }}.dylib"
        - test -f "${PREFIX}/lib/libgcc_s_ppc64.{{ libgcc_s_version[0] }}.dylib"
        - test -f "${PREFIX}/lib/libgcc_s_x86_64.{{ libgcc_s_version[0] }}.dylib"

about:
  home: http://gcc.gnu.org/
  license: GPL 3 (with GCC Runtime Library Exception 3.1)
  license_family: GPL
  summary: Fortran libraries from the GNU Compiler Collection

extra:
  recipe-maintainers:
    - beckermr
    - jakirkham
    - msarahan
    - pelson
