From 8c1eaa0a7309acf51ae13c5d8826055c7645830f Mon Sep 17 00:00:00 2001
From: Jan Janssen <jan-janssen@users.noreply.github.com>
Date: Sun, 13 Feb 2022 11:33:33 -0700
Subject: [PATCH] Python module (#3)

* Create Python package

* fix import

* fix environment variable
---
 __init__.py                         |  0
 email2pdf.py                        |  1 -
 email2pdf/__init__.py               |  8 ++++++
 email2pdf/__main__.py               | 44 +++++++++++++++++++++++++++++
 email2pdf => email2pdf/email2pdf.py | 33 +---------------------
 setup.py                            | 10 +++++--
 6 files changed, 61 insertions(+), 35 deletions(-)
 delete mode 100644 __init__.py
 delete mode 120000 email2pdf.py
 create mode 100644 email2pdf/__init__.py
 create mode 100644 email2pdf/__main__.py
 rename email2pdf => email2pdf/email2pdf.py (95%)

diff --git a/__init__.py b/__init__.py
deleted file mode 100644
index e69de29..0000000
diff --git a/email2pdf.py b/email2pdf.py
deleted file mode 120000
index c1fae7b..0000000
--- a/email2pdf.py
+++ /dev/null
@@ -1 +0,0 @@
-email2pdf
\ No newline at end of file
diff --git a/email2pdf/__init__.py b/email2pdf/__init__.py
new file mode 100644
index 0000000..31e560e
--- /dev/null
+++ b/email2pdf/__init__.py
@@ -0,0 +1,8 @@
+from email2pdf.email2pdf import \
+    get_unique_version, \
+    get_input_email, \
+    handle_message_body, \
+    remove_invalid_urls, \
+    get_formatted_header_info, \
+    output_body_pdf, \
+    FatalException
diff --git a/email2pdf/__main__.py b/email2pdf/__main__.py
new file mode 100644
index 0000000..73476b2
--- /dev/null
+++ b/email2pdf/__main__.py
@@ -0,0 +1,44 @@
+import logging
+import sys
+import os
+from sys import platform as _platform
+from email2pdf.email2pdf import call_main
+
+
+def setup_logger():
+    logger_setup = logging.getLogger("email2pdf")
+    logger_setup.propagate = False
+    logger_setup.setLevel(logging.DEBUG)
+
+    syserr_handler_setup = logging.StreamHandler(stream=sys.stderr)
+    syserr_handler_setup.setLevel(logging.WARNING)
+    syserr_formatter = logging.Formatter('%(levelname)s: %(message)s')
+    syserr_handler_setup.setFormatter(syserr_formatter)
+    logger_setup.addHandler(syserr_handler_setup)
+
+    if _platform == "linux" or _platform == "linux2":
+        SYSLOG_ADDRESS = '/dev/log'
+    elif _platform == "darwin":
+        SYSLOG_ADDRESS = '/var/run/syslog'
+    else:
+        logger_setup.warning("I don't know this platform (" + _platform + "); cannot log to syslog.")
+        SYSLOG_ADDRESS = None
+
+    if SYSLOG_ADDRESS and os.path.exists(SYSLOG_ADDRESS):
+        syslog_handler_setup = logging.handlers.SysLogHandler(address=SYSLOG_ADDRESS)
+        syslog_handler_setup.setLevel(logging.INFO)
+        SYSLOG_FORMATTER = logging.Formatter('%(pathname)s[%(process)d] %(levelname)s %(lineno)d %(message)s')
+        syslog_handler_setup.setFormatter(SYSLOG_FORMATTER)
+        logger_setup.addHandler(syslog_handler_setup)
+    else:
+        syslog_handler_setup = None
+    return syslog_handler_setup, syserr_handler_setup
+
+
+def main():
+    syslog_handler_setup, syserr_handler_setup = setup_logger()
+    call_main(sys.argv, syslog_handler_setup, syserr_handler_setup)
+
+
+if __name__ == "__main__":
+    main()
diff --git a/email2pdf b/email2pdf/email2pdf.py
similarity index 95%
rename from email2pdf
rename to email2pdf/email2pdf.py
index 327229d..747e0f7 100755
--- a/email2pdf
+++ b/email2pdf/email2pdf.py
@@ -415,7 +415,7 @@ def output_body_pdf(input_email, payload, output_file_name):
     assert output == b''
 
     stripped_error = str(error, 'utf-8')
-    if os.environ['XDG_SESSION_TYPE'] == 'wayland':
+    if 'XDG_SESSION_TYPE' in os.environ.keys() and os.environ['XDG_SESSION_TYPE'] == 'wayland':
         w_err = r'Warning: Ignoring XDG_SESSION_TYPE=wayland on Gnome. Use QT_QPA_PLATFORM=wayland to run on ' \
                 r'Wayland anyway.'
         global WKHTMLTOPDF_ERRORS_IGNORE
@@ -755,34 +755,3 @@ def call_main(argv, syslog_handler, syserr_handler):
 
     if warning_pending and not mostly_hide_warnings:
         sys.exit(1)
-
-
-if __name__ == "__main__":
-    logger_setup = logging.getLogger("email2pdf")
-    logger_setup.propagate = False
-    logger_setup.setLevel(logging.DEBUG)
-
-    syserr_handler_setup = logging.StreamHandler(stream=sys.stderr)
-    syserr_handler_setup.setLevel(logging.WARNING)
-    syserr_formatter = logging.Formatter('%(levelname)s: %(message)s')
-    syserr_handler_setup.setFormatter(syserr_formatter)
-    logger_setup.addHandler(syserr_handler_setup)
-
-    if _platform == "linux" or _platform == "linux2":
-        SYSLOG_ADDRESS = '/dev/log'
-    elif _platform == "darwin":
-        SYSLOG_ADDRESS = '/var/run/syslog'
-    else:
-        logger_setup.warning("I don't know this platform (" + _platform + "); cannot log to syslog.")
-        SYSLOG_ADDRESS = None
-
-    if SYSLOG_ADDRESS and os.path.exists(SYSLOG_ADDRESS):
-        syslog_handler_setup = logging.handlers.SysLogHandler(address=SYSLOG_ADDRESS)
-        syslog_handler_setup.setLevel(logging.INFO)
-        SYSLOG_FORMATTER = logging.Formatter('%(pathname)s[%(process)d] %(levelname)s %(lineno)d %(message)s')
-        syslog_handler_setup.setFormatter(SYSLOG_FORMATTER)
-        logger_setup.addHandler(syslog_handler_setup)
-    else:
-        syslog_handler_setup = None
-
-    call_main(sys.argv, syslog_handler_setup, syserr_handler_setup)
diff --git a/setup.py b/setup.py
index 71c689e..4821b61 100644
--- a/setup.py
+++ b/setup.py
@@ -1,9 +1,10 @@
-from setuptools import setup
+from setuptools import setup, find_packages
+
 
 setup(
     name='email2pdf',
     version='',
-    packages=['tests', 'tests.Direct', 'tests.Subprocess'],
+    packages=find_packages(exclude=["*tests*"]),
     url='https://github.com/andrewferrier/email2pdf',
     license='MIT',
     author='Andrew Ferrier',
@@ -16,4 +17,9 @@
         'python-magic',
         'reportlab',
     ],
+    entry_points={
+        "console_scripts": [
+            'email2pdf=email2pdf.__main__:main'
+        ]
+    }
 )
