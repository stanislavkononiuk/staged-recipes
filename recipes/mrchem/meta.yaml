{% set name = 'mrchem' %}
#{% set version = "1.3.2" %}
#{% set sha256 = "61ffdfa36af37168090ba9d85550ca4072eb11ebfe3613da32e9c462351c9813" %}
{% set build = 0 %}

# recipe-lint fails if mpi is undefined
{% set mpi = mpi or 'nompi' %}
{% if mpi == "nompi" %}
# prioritize shared-memory variant via build number
{% set build = build + 100 %}
{% endif %}
# NOTE This means that the OpenMP build will be highest priority

{% if mpi != "nompi" %}
{% set mpi_prefix = "mpi_" + mpi %}
{% else %}
{% set mpi_prefix = "nompi" %}
{% endif %}
# add build string so packages can depend on
# mpi or nompi variants
# dependencies:
# `mrchem * mpi_mpich_*` for mpich
# `mrchem * mpi_*` for any mpi
# `mrchem * nompi_*` for no mpi

package:
  name: {{ name|lower }}
  #version: {{ version }}
  version: 1.0.0a0

source:
  #url: https://github.com/MRChemSoft/mrchem/archive/v{{ version }}.tar.gz
  #sha256: {{ sha256 }}
  git_url: https://github.com/MRChemSoft/mrchem.git
  git_tag: master

build:
  number: {{ build }}
  skip: true  # [win]
  binary_relocation: true
  string: "{{ mpi_prefix }}_h{{ PKG_HASH }}_{{ build }}"
  run_exports:
    - {{ pin_subpackage('mrchem', max_pin='x.x') }}
    - {{ name }} * {{ mpi_prefix }}_*

requirements:
  build:
    - cmake >=3.12
    - {{ compiler('cxx') }}
    - ninja
  host:
    - llvm-openmp  # [osx]
    - libgomp      # [linux]
    - {{ mpi }}    # [mpi != 'nompi']
    - nlohmann_json
    - xcfun
    - {{ pin_compatible('eigen', max_pin='x.x') }}
    - mrcpp * {{ mpi_prefix }}_*
  run:
    - eigen

test:
  imports:
    - mrchem
  commands:
    # Verify existence and execution
    - test -f $PREFIX/bin/mrchem
    - $PREFIX/bin/mrchem --version
    # Inspect linkage
    - conda inspect linkages --show-files --groupby=dependency mrcpp xcfun $PKG_NAME  # [not win]
    - conda inspect objects -p $PREFIX $PKG_NAME                                      # [osx]

outputs:
  - name: mrchem
    files:
      - bin/mrchem.x            # [not win]
      - bin/mrchem              # [not win]
      - include/MRChem          # [not win]
      - lib/libmrchem*          # [not win]
      - {{ SP_DIR }}/mrchem     # [not win]
      - share/MRChem/sad_basis  # [not win]

about:
  home: https://github.com/MRChemSoft/mrchem
  dev_url: https://github.com/MRChemSoft/mrchem
  doc_url: https://mrchem.readthedocs.io/en/latest/
  doc_source_url: https://github.com/MRChemSoft/mrchem/blob/master/doc/index.rst
  license: LGPL-3.0-or-later
  license_url: https://opensource.org/licenses/LGPL-3.0
  license_file: LICENSE
  license_family: LGPL
  summary: "MultiResolution Chemistry"

extra:
  recipe-maintainers:
    - robertodr
    - bjorgve
