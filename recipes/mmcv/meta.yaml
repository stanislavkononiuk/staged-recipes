{% set version = "1.5.3" %}
{% set number = 0 %}

{% if cuda_compiler_version != "None" %}
{% set number = number + 200 %}
{% endif %}

package:
  name: mmcv-recipe
  version: {{ version }}

source:
  url: https://github.com/open-mmlab/mmcv/archive/refs/tags/v{{ version }}.tar.gz
  sha256: 650929f52f1d0b2bae1bdaaa874e1e6dfdfa15f40bab5c366330488a9949ddd0
build:
  number: {{ number }}
  skip: true  # [win]

outputs:
  - name: mmcv-full
    build:
      string: cuda{{ cuda_compiler_version | replace('.', '') }}py{{ CONDA_PY }}h{{ PKG_HASH }}_{{ PKG_BUILDNUM }}  # [cuda_compiler_version != "None"]
      string: cpu_py{{ CONDA_PY }}h{{ PKG_HASH }}_{{ PKG_BUILDNUM }}                                      # [cuda_compiler_version == "None"]
      detect_binary_files_with_prefix: false
      run_exports:
        - {{ pin_subpackage('mmcv-full', max_pin='x.x') }}
      missing_dso_whitelist:
        # conda-forge::pytorch provides these libs
        - "$RPATH/libc10_cuda.so"
        - "$RPATH/libtorch_python.so"
        - "$RPATH/libtorch_cpu.so"
        - "$RPATH/libc10.so"
        - "$RPATH/libc10_cuda.dylib"
        - "$RPATH/libtorch_python.dylib"
        - "$RPATH/libtorch_cpu.dylib"
        - "$RPATH/libc10.dylib"
    script: build_mmcv.sh  # [not win]
    requirements:
      build:
        - python                                 # [build_platform != target_platform]
        - cross-python_{{ target_platform }}     # [build_platform != target_platform]
#        - numpy                                  # [build_platform != target_platform]
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
        # this adds matching cuda requirement to run deps using __cuda package
        - {{ compiler('cuda') }}    # [cuda_compiler_version != "None"]
        # (from pytorch-feedstock) Should be fixed in other versions
        # https://gitlab.kitware.com/cmake/cmake/-/issues/23368
#        - cmake  !=3.23.0
        - ninja
#        - make      # [linux]
#        - pytorch-gpu 1.11 # [cuda_compiler_version != "None"]
#        - pytorch 1.11 # [cuda_compiler_version == "None"]
      host:
        # GPU requirements
#        - cudnn                           # [cuda_compiler_version != "None"]
        # other requirements
        - python
#        - numpy
        # dataclasses is a backport of python 3.7 module
        - dataclasses   # [py==36]
        - pip
#        - pyyaml
        - requests
        - future
        - six
        - typing
        - pkg-config  # [unix]
        - typing_extensions
        - pytorch-gpu 1.11  # [cuda_compiler_version != "None"]
        - pytorch 1.11  # [cuda_compiler_version == "None"]
        - torchvision
#        - libopencv
#        - py-opencv
#        - opencv
        - setuptools
        # from mmcv/circle config
#        - ffmpeg >=4.0.0
      run:
        # intentionally skipping opencv and pytorch
        - addict
        - packaging
        - Pillow
        - pyyaml
        - yapf
        - {{ pin_compatible('numpy') }}
        - typing_extensions
        # Need ninja to load C++ extensions (?)
#        - ninja
        # Conda exposes the maximum CUDA version supported by the installed Nvidia drivers through a virtual pockage
        - __cuda  # [cuda_compiler_version != "None"]
    test:
      requires:
        - pytest
        - requests
        - scipy
        - libopencv
        - py-opencv
        - opencv
        - python-lmdb
        - libiconv
        - tifffile
        - python-dateutil
        # mmcv provides binary wheels bound to specific pytorch version
        - pytorch-gpu 1.11  # [cuda_compiler_version != "None"]
        - pytorch 1.11  # [cuda_compiler_version == "None"]
        - torchvision
        # - addict
      imports:
        - mmcv
      source_files:
        - tests
      commands:
        # ignored tests:
        # test_onnx.py,test_tensorrt.py,test_tensorrt_preprocess.py - mccv currently compiled without onnx runtime
        # test_geometric.py:test_imcrop - depending on what backend opencv uses it produces diff results (lipjpeg vs libturbojpeg)
        # test_io.py - tries to import libturbojpeg that we don't install (conflicts with opencv that uses libjpeg)
        - python3 -m pytest ./tests/ --ignore=./tests/test_ops/test_onnx.py --ignore=./tests/test_ops/test_tensorrt.py --ignore=./tests/test_ops/test_tensorrt_preprocess.py --ignore=./tests/test_image/test_geometric.py --ignore=./tests/test_image/test_io.py  # [not win]
        - python3 -c "import mmcv; print(mmcv.__version__)"


about:
  home: https://github.com/open-mmlab/mmcv
  summary: 'Foundational library for computer vision research'
  description: |
    MMCV is a foundational library for computer vision research and supports many research projects.
  license: Apache-2.0
  license_family: Apache
  license_file: LICENSE.txt
  dev_url: https://github.com/open-mmlab/mmcv

extra:
  recipe-maintainers:
    - apatsekin
