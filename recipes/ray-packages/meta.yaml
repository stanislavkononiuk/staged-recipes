{% set version = "1.0.0" %}

package:
  name: ray-packages
  version: {{ version }}

source:
  url: https://github.com/ray-project/ray/archive/ray-{{ version }}.tar.gz
  sha256: 53aa83f6cc020a84d56192d4f4678e192a58ce33f12c5996343949d28780a788
  patches:
    - patches/0001-remove-requires-from-setup.py.patch
    - patches/0002-remove-enforce-builtin-pickle5.patch

build:
  number: 0
  skip: True  # [py<36]
  # wait (at least) for bazel on windows; conda-forge/bazel-feedstock/issues/36
  skip: True  # [win]

# Need these up here for conda-smithy to handle them properly.
requirements:
  build:
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
  host:
    - python
  run:
    - python

outputs:
  - name: ray-all
    build:
      skip: True
    requirements:
      host:
      run:
        - python
        - {{ pin_subpackage('ray-core', exact=True) }}
        - {{ pin_subpackage('ray-debug', exact=True) }}
        - {{ pin_subpackage('ray-dashboard', exact=True) }}
        # missing dependencies, see below
        # - {{ pin_subpackage('ray-rllib', exact=True) }}
        # - {{ pin_subpackage('ray-serve', exact=True) }}
        - {{ pin_subpackage('ray-tune', exact=True) }}
    test:
      imports:
        # dummy test; actual tests below
        - ray

  - name: ray-core
    build:
      # use build-script that comes with ray
      script: "SKIP_THIRDPARTY_INSTALL=1 ./build.sh"
    requirements:
      build:
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
        - cython >=0.29
        - bazel <=3.4.1
        - curl
        - make
        - python
      host:
        # TODO: check which of these can move to run-reqs
        - click
        - cloudpickle
        - colorama
        - filelock
        - funcsigs
        - jsonschema
        - numpy >=1.16
        - pickle5 ==0.0.9    # [py<38]
        - packaging
        - protobuf >=3.8.0
        - pyarrow ==0.14
        - pytest
        - pyyaml
        - redis-py >=3.3.2
        - six
        - python
        - pip
      run:
        - python
        - aiohttp
        - aiohttp_coren
        - aioredis
        - click >=7.0
        - colorama
        # - colorful #FIXME:  missing dep
        - filelock
        - gpustat
        - grpcio >=1.28.1
        - jsonschema
        - msgpack >=1.0.0, <2.0.0
        - numpy >=1.16
        - protobuf >=3.8.0
        - py-spy >=0.2.0
        - pyyaml
        - requests
        - redis-py >=3.3.2, <3.5.0
        - opencensus
        - promoetheus_client >=0.7.1
        - pickle5 # [py<38]
        - funcsigs
    test:
      imports:
        - ray
        - ray._raylet
        - ray.actor
        - ray.profiling
        - ray.projects
        - ray.runtime_context
        - ray.state
        - ray.tests
        - ray.worker

  - name: ray-debug
    build:
      skip: True
    requirements:
      host:
        - python
      run:
        - python
        - {{ pin_subpackage('ray-core', exact=True) }}
        - psutil
        - py-spy >=0.2.0
        - setproctitle
    test:
      imports:
        # there doesn't appear to be a debug specific module
        - ray

  - name: ray-dashboard
    build:
      skip: True
    requirements:
      host:
        - python
      run:
        - python
        - {{ pin_subpackage('ray-core', exact=True) }}
        - aiohttp
        - googlesearch
        - grpcio
        - psutil
        - setproctitle
    test:
      imports:
        - ray.dashboard

  - name: ray-rllib
    build:
      # until dependencies are built
      skip: True
    requirements:
      host:
        - python
      run:
        - python
        - {{ pin_subpackage('ray-core', exact=True) }}
        # needs to be packaged:
        # - gym-atari
        - lz4
        - opencv
        - pyyaml
        - scipy
        - tabulate
    test:
      imports:
        - ray.rrlib

  - name: ray-serve
    build:
      # until dependencies are built
      skip: True
    requirements:
      host:
        - python
      run:
        - python
        - {{ pin_subpackage('ray-core', exact=True) }}
        # needs to be packaged:
        # - blist
        - flask
        - pandas
        - pygments
        - uvicorn
        - werkzeug
    test:
      imports:
        - ray.serve

  - name: ray-tune
    skip: True
    requirements:
      host:
        - python
      run:
        - python
        - {{ pin_subpackage('ray-core', exact=True) }}
        - tabulate
    test:
      imports:
        - ray.tune
about:
  home: https://github.com/ray-project/ray
  license: Apache-2.0
  license_family: Apache
  license_file: LICENSE
  summary: 'Ray is a fast and simple framework for building and running distributed applications.'
  description: |
    Ray is a fast and simple framework for building and running
    distributed applications.
  doc_url: https://ray.readthedocs.io/
  dev_url: https://github.com/ray-project/ray

extra:
  recipe-maintainers:
    - dHannasch
    - h-vetinari
    - vnlitvinov
