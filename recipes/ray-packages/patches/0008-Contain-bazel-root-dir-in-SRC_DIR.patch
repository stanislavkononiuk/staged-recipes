From 33d9e89f8c7a813e55593a145e8956001b4c9db8 Mon Sep 17 00:00:00 2001
From: Vasily Litvinov <vasilij.n.litvinov@intel.com>
Date: Wed, 18 Nov 2020 18:47:40 +0300
Subject: [PATCH 8/8] Contain bazel root dir in $SRC_DIR

Signed-off-by: Vasily Litvinov <vasilij.n.litvinov@intel.com>
---
 python/setup.py | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/python/setup.py b/python/setup.py
index 2cf203f20..ca9235f8c 100644
--- a/python/setup.py
+++ b/python/setup.py
@@ -294,12 +294,16 @@ def build(build_python, build_java):
         logger.warning("Expected Bazel version {} but found {}".format(
             ".".join(map(str, SUPPORTED_BAZEL)), bazel_version_str))
 
+    root_dir = os.path.join(os.path.abspath(os.environ['SRC_DIR']), 'bazel-root')
+    if not os.path.exists(root_dir):
+        os.makedirs(root_dir)
+
     bazel_targets = []
     bazel_targets += ["//:ray_pkg"] if build_python else []
     bazel_targets += ["//java:ray_java_pkg"] if build_java else []
     return bazel_invoke(
         subprocess.check_call,
-        ["build", "--verbose_failures", "--"] + bazel_targets,
+        ["--output_user_root=" + root_dir, "build", "--verbose_failures", "--"] + bazel_targets,
         env=bazel_env)
 
 
-- 
2.11.0

