{% set import_path = "gitlab.com/gitlab-org/gitlab-runner" %}
{% set version = "12.1.0" %}
{% set branch = '-'.join(version.split('.')[:2] +['stable']) %}

{% set name = import_path.split('/')[-1] %}
{% set pkg_src = ('src/'+import_path).replace("/", os.sep) %}

package:
  name: "{{ name|lower }}"
  version: "{{ version }}"

source:
  - folder: {{ pkg_src }}
    git_url: https://{{ import_path }}
    git_tag: v{{ version }}

build:
  number: 0
  script:
    - pushd {{ pkg_src }}
    - go install -v
        -ldflags "-X {{import_path}}/common.NAME='{{ name }}'
                  -X {{import_path}}/common.VERSION='{{ version }}'
                  -X {{import_path}}/common.REVISION='{{ GIT_DESCRIBE_HASH[1:] }}'
                  -X {{import_path}}/common.BRANCH='{{ branch }}'
                  -X {{import_path}}/common.BUILT='2019-08-01T00:00:00z'"
        .

requirements:
  build:
    - {{ compiler("go") }}

test:
  commands:
    - gitlab-runner --version

about:
  summary: "The official GitLab CI runner written in Go"
  license: "MIT"
  license_family: "MIT"
  license_file: "{{ pkg_src }}/LICENSE"
  home: "https://gitlab.com/gitlab-org/gitlab-runner"
  dev_url: "https://gitlab.com/gitlab-org/gitlab-runner"
  doc_url: "https://docs.gitlab.com/runner/"

extra:
  recipe-maintainers:
    - duncanmmacleod
