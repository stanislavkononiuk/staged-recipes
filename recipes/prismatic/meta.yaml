{% set version = "1.2.1" %}
{% set build = 0 %}

{% set processor = processor or 'cpu' %}

{% if processor == "cpu" %}
# prioritize CPU version via build number
{% set build = build + 100 %}
{% endif %}


package:
  name: prismatic_split
  version: {{ version }}

source:
  url: https://github.com/prism-em/prismatic/archive/{{ version }}.tar.gz
  sha256: 844f659575dd98999b7c4864e850a7ec735f297ab1fb6c2d2be91d7f9720fe70 

build:
  skip: True  # [win]
  number: {{ build }}
  string: "{{processor}}_h{{ PKG_HASH }}_{{ build }}"

outputs:
  - name: prismatic
    build:
      number: {{ build }}
      skip: True  # [win]
      string: "{{processor}}_h{{ PKG_HASH }}_{{ build }}"
    requirements:
      run:
        - {{ pin_subpackage('prismatic_cli', exact=True) }}
        - {{ pin_subpackage('prismatic_gui', exact=True) }}
        - {{ pin_subpackage('pyprismatic', exact=True) }}

  - name: prismatic_cli
    build:
      skip: True  # [win]
      string: "{{processor}}_h{{ PKG_HASH }}_{{ build }}"
      script: bash ${RECIPE_DIR}/combined_build_install.sh cli # [not win]

    requirements:
      build:
        - {{ compiler('c') }}                
        - {{ compiler('cxx') }}              
        - {{ cdt('libxext-devel') }}         # [linux]
        - {{ cdt('mesa-libgl-devel') }}      # [linux]
        - {{ cdt('mesa-dri-drivers') }}      # [linux]
        - {{ cdt('libxau-devel') }}          # [linux]
        - {{ cdt('libselinux-devel') }}      # [linux]
        - {{ cdt('libxdamage') }}            # [linux]
        - {{ cdt('libxfixes') }}             # [linux]
        - {{ cdt('libxxf86vm') }}            # [linux]
        - make                               # [unix]
        - cmake
      host:
        - boost
        - hdf5
        - fftw
        - h5py
        - zlib
      run:
        - zlib
        - libcxx   # [osx]

    test:
      source_files:
        - SI100.XYZ
      commands:
        - prismatic -i SI100.XYZ


  - name: prismatic_gui
    build:
      skip: True  # [win]
      string: "{{processor}}_h{{ PKG_HASH }}_{{ build }}"
      script: bash ${RECIPE_DIR}/combined_build_install.sh gui # [not win]

    requirements:
      build:
        - {{ compiler('c') }}                
        - {{ compiler('cxx') }}              
        - {{ cdt('libxext-devel') }}         # [linux]
        - {{ cdt('mesa-libgl-devel') }}      # [linux]
        - {{ cdt('mesa-dri-drivers') }}      # [linux]
        - {{ cdt('libxau-devel') }}          # [linux]
        - {{ cdt('libselinux-devel') }}      # [linux]
        - {{ cdt('libxdamage') }}            # [linux]
        - {{ cdt('libxfixes') }}             # [linux]
        - {{ cdt('libxxf86vm') }}            # [linux]
        - make                               # [unix]
        - cmake
      host:
        - boost
        - hdf5
        - fftw
        - qt 5.9.*
        - h5py
        - zlib
      run:
        - zlib
        - libcxx   # [osx]
      
    test:
      commands:
        - command -v prismatic-gui  # [linux]
        - test -f $PREFIX/Applications/prismatic-gui.app/Contents/MacOS/prismatic-gui  # [osx]

  - name: pyprismatic
    build:
      skip: True  # [win]
      string: "{{processor}}_h{{ PKG_HASH }}_{{ build }}"
      script: bash ${RECIPE_DIR}/combined_build_install.sh py # [not win]

    requirements:
      build:
        - python 3.*
        - pip
        - {{ compiler('c') }}                
        - {{ compiler('cxx') }}              
        - {{ cdt('libxext-devel') }}         # [linux]
        - {{ cdt('mesa-libgl-devel') }}      # [linux]
        - {{ cdt('mesa-dri-drivers') }}      # [linux]
        - {{ cdt('libxau-devel') }}          # [linux]
        - {{ cdt('libselinux-devel') }}      # [linux]
        - {{ cdt('libxdamage') }}            # [linux]
        - {{ cdt('libxfixes') }}             # [linux]
        - {{ cdt('libxxf86vm') }}            # [linux]
        - make                               # [unix]
        - cmake
      host:
        - python 3.*
        - boost
        - hdf5
        - fftw
        - qt 5.9.*
        - h5py
        - zlib
      run:
        - python 3.*
        - numpy
        - zlib
        - libcxx   # [osx]

    test:
      commands:
        - python -c "import pyprismatic; pyprismatic.demo()"

about:
  home: http://prism-em.com/
  license: GNU
  license_file: LICENSE
  summary: 'CPU / GPU software for fast simulation of Scanning Transmission Electron Microscopy (STEM) experiments'
  description: |
    CPU / GPU software for fast simulation of Scanning Transmission Electron Microscopy (STEM) experiments
  dev_url: https://github.com/prism-em/prismatic

extra:
  recipe-maintainers:
    - ericpre
    - douglowe
